<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.geasy.marketing.dao.wechat.ChatRecordsMapper">
    <resultMap id="Base_Result_Map" type="cn.com.geasy.marketing.domain.dto.wechat.WxCustomerDto">
        <id property="id" column="id" jdbcType="BIGINT" javaType="Long"/>
        <result property="customerId" column="customer_id" javaType="Long"/>
        <result property="wxUsername" column="wx_username" jdbcType="VARCHAR" javaType="String"/>
        <result property="headImgUrl" column="head_img_url" jdbcType="VARCHAR" javaType="String"/>
        <result property="nickname" column="nickname" jdbcType="VARCHAR" javaType="String"/>
        <result property="msgType" column="msg_type" jdbcType="TINYINT" javaType="Integer"/>
        <result property="content" column="content" jdbcType="VARCHAR" javaType="String"/>
        <result property="url" column="url" jdbcType="VARCHAR" javaType="String"/>
        <result property="isSend" column="is_send" jdbcType="TINYINT" javaType="Integer"/>
        <result property="sendTime" column="send_time" jdbcType="TIMESTAMP" javaType="java.time.LocalDateTime"/>
    </resultMap>

    <select id="findUncontactCustomer" resultMap="Base_Result_Map" parameterType="java.util.Map">
        SELECT * FROM (SELECT r.*,wc.head_img_url,wc.nickname FROM wx_contact wc INNER JOIN  (SELECT a.id,a.customer_id,a.wx_username, a.msg_type,a.content,a.url, a.is_send,a.send_time
        FROM chat_records a LEFT JOIN chat_records b ON a.wx_username = b.wx_username  AND a.send_time <![CDATA[ < ]]> b.send_time
        <where>
            <if test="userId!=null">
                a.create_user= ${userId}
            </if>
        </where>
        GROUP BY a.wx_username, a.send_time HAVING COUNT(b.id) <![CDATA[ < ]]> 1
        <if test="isSort==1">
            ORDER BY a.send_time DESC
        </if>
        ) r ON wc.username=r.wx_username) t ORDER BY t.send_time ASC
    </select>
</mapper>