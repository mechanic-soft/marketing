<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.geasy.marketing.dao.customer.CustomerMapper">
    <resultMap id="Base_Result_Map" type="cn.com.geasy.marketing.domain.dto.customer.CustomerDto">
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="call_time" property="callTime" jdbcType="TIMESTAMP" />
        <result column="wx_id" property="wxId" jdbcType="VARCHAR" />
        <result column="remark" property="remark" jdbcType="VARCHAR" />
        <result column="phone" property="phone" jdbcType="VARCHAR" />
        <result column="maturity" property="maturity" jdbcType="TINYINT" />
        <result column="wx_contact_id" property="wxContactId" jdbcType="VARCHAR" />
        <!--wx_contact-->
        <result column="nick_name" property="nickName" jdbcType="VARCHAR" />
        <result column="head_img_url" property="headImgUrl" jdbcType="VARCHAR" />

        <!--customer_lifecycle_event -->
        <result column="isAddWechat" property="isAddWechat" jdbcType="TINYINT" />
        <result column="isOpenAccount" property="isOpenAccount" jdbcType="TINYINT" />

        <result column="lastContact" property="lastContact" jdbcType="VARCHAR" />
    </resultMap>

    <select id="findOpenAccountCustomerDtoIds"  parameterType="java.util.ArrayList"
            resultMap="Base_Result_Map">
        select t1.customer_id as id from rele_customer_tag t1
        left join tag t2 on t1.tag_id = t2.id
        where 1=1
        and t1.status = 1
        and t2.name = '已开户'
        <if test="ids != null and ids.size > 0 ">
            and t1.customer_id in
            <foreach collection="ids" item="item" open="(" close=")" separator=",">
                ${item}
            </foreach>
        </if>
    </select>

    <!--客户列表查询，分页-->
    <select id="selectDtoPage" parameterType="cn.com.geasy.marketing.domain.dto.customer.CustomerDto"
            resultMap="Base_Result_Map">

        <include refid="Base_sql2"/>
    </select>

    <!--客户列表查询，不分页-->
    <select id="selectDtoList" parameterType="cn.com.geasy.marketing.domain.dto.customer.CustomerDto"
            resultMap="Base_Result_Map">
        <include refid="Base_sql2"/>
    </select>

    <sql id="Base_sql2">
        SELECT t1.id
        ,date_format(t1.call_time, '%Y-%m-%d') AS call_time
        ,t1.wx_id
        ,t2.remark_name as remark
        ,t1.phone
        ,t1.maturity
        ,t2.nick_name
        ,t2.head_img_url
        ,t1.wx_contact_id
        FROM customer t1

        LEFT JOIN wx_contact t2 ON t1.wx_contact_id = t2.id

        <!--标签交集 -->
        <if test="customerDto.tagIds != null and customerDto.tagIds.size > 0 ">
            inner JOIN (
                select customer_id,count(1) from rele_customer_tag t4 where 1=1
                    AND  t4.tag_id  in

                    <foreach collection="customerDto.tagIds" item="item" open="(" close=")" separator=",">
                        ${item}
                    </foreach>

                    and t4.status = 1

                    AND t4.create_user =#{customerDto.userId}

                group by customer_id   having count(*) = ${customerDto.tagIds.size}

            ) t3 ON t3.customer_id = t1.id
        </if>


        WHERE 1 = 1

        and t1.status = 1


        <if test="customerDto.nickName != null and customerDto.nickName != ''">
            AND t2.nick_name LIKE CONCAT('%',#{customerDto.nickName},'%')
        </if>

        <!--wx_contact_id   null 就是未加微信-->

        <if test="customerDto.isAddWechat == 1">
            AND t1.wx_contact_id IS NOT NULL
        </if>

        <if test="customerDto.isAddWechat == 0">
            AND t1.wx_contact_id IS NULL
        </if>


        <!--查询当前用户下的客户信息-->
        <if test="customerDto.userId != null">
            AND t1.user_Id = #{customerDto.userId}
        </if>




        <if test="customerDto.callTimeStartStr != null and customerDto.callTimeStartStr != ''">
            AND t1.call_time  &gt;= '${customerDto.callTimeStartStr} 00:00:00'
        </if>

        <if test="customerDto.callTimeEndStr != null and customerDto.callTimeEndStr != ''">
            AND t1.call_time    &lt;=  '${customerDto.callTimeEndStr} 23:59:59'
        </if>
    </sql>

    <sql id="Base_sql">
        SELECT DISTINCT (t1.id)
        ,date_format(t1.call_time, '%Y-%m-%d') AS call_time
        ,t1.wx_id
        ,t2.remark_name as remark
        ,t1.phone
        ,t1.maturity
        ,t2.nick_name
        ,t2.head_img_url
        ,t1.wx_contact_id
        FROM customer t1
        LEFT JOIN wx_contact t2 ON t1.wx_contact_id = t2.id
        LEFT JOIN rele_customer_tag t3 ON t3.customer_id = t1.id
        WHERE 1 = 1

        and t1.status = 1


        <if test="customerDto.nickName != null and customerDto.nickName != ''">
            AND t2.nick_name LIKE CONCAT('%',#{customerDto.nickName},'%')
        </if>

        <!--wx_contact_id   null 就是未加微信-->
        <if test="customerDto.isAddWechat != null and customerDto.isAddWechat != ''">
            AND t1.wx_contact_id IS NOT NULL
        </if>

        <!--查询当前用户下的客户信息-->
        <if test="customerDto.userId != null">
            AND t1.user_Id = #{customerDto.userId}
        </if>


        <if test="customerDto.tagIds != null and customerDto.tagIds.size > 0 ">
            AND  t3.tag_id  in

            <foreach collection="customerDto.tagIds" item="item" open="(" close=")" separator=",">
                ${item}
            </foreach>
        </if>

        <if test="customerDto.callTimeStartStr != null and customerDto.callTimeStartStr != ''">
            AND t1.call_time  &gt;= ${customerDto.callTimeStartStr}
        </if>

        <if test="customerDto.callTimeEndStr != null and customerDto.callTimeEndStr != ''">
            AND t1.call_time    &lt;=  '${customerDto.callTimeEndStr} 23:59:59'
        </if>
    </sql>


</mapper>